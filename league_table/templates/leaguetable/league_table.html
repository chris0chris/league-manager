{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="card" style="overflow: auto">
    <div aria-controls="collapseSchedule" aria-expanded="true" class="card-header" data-target="#collapseSchedule"
         data-toggle="collapse" id="headingSchedule" role="button">
        <h2>Gesamttabelle</h2>
    </div>
    <div aria-labelledby="headingSchedule" class="collapse show" id="collapseSchedule">
        <div class="card-body">
            {% if info.table == None %}
            Tabelle wurde noch nicht erstellt.
            {% else %}
            <div x-data="{
                    showTieBreakCols: false,
                    showTableLong: false,
                    search: '',

                    fuzzyMatch(pattern, text) {
                        pattern = pattern.toLowerCase();
                        text = text.toLowerCase();
                        let i = 0, j = 0;
                        while (i < pattern.length && j < text.length) {
                            if (pattern[i] === text[j]) i++;
                            j++;
                        }
                        return i === pattern.length;
                    },

                    highlightMultiple(text) {
                        if (!this.search) return text;
                        const escaped = this.search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const pattern = new RegExp(escaped, 'gi');
                        return text.replace(pattern, m => `<mark>${m}</mark>`);
                    }
                }"
            >
                <div class="mb-2">
                    <button class="btn btn-sm btn-outline-secondary"
                            @click="showTableLong = !showTableLong">
                    <span class="ms-1"
                          x-text="showTableLong ? 'Kurze Tabellennamen anzeigen' : 'Tabellennamen ausschreiben'"></span>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary"
                            @click="showTieBreakCols = !showTieBreakCols">
                        <i class="bi"
                           :class="showTieBreakCols ? 'bi-arrows-collapse-vertical' : 'bi-arrows-expand-vertical'">
                        </i>
                        <span class="ms-1"
                              x-text="showTieBreakCols ? 'TieBreak Spalten ausblenden' : 'TieBreak Spalten anzeigen'"></span>
                    </button>
                </div>
                <div class="">
                    <input type="text"
                           class="form-control"
                           placeholder="Team suchenâ€¦"
                           x-model="search"
                    >
                </div>
                <table class="table table-hover table-condensed table-responsive text-center">

                    <thead>
                    <tr>
                        {% if user.is_staff %}
                        <th>Team-ID</th>
                        {% endif %}

                        <th>Rang</th>
                        <th>Team</th>
                        <th>
                            <span x-show="!showTableLong">SQ</span>
                            <span x-show="showTableLong">Siegquotient</span>
                        </th>
                        <th>
                            <span x-show="!showTableLong">EP</span>
                            <span x-show="showTableLong">Erzielte Punkte</span>
                        </th>
                        <th>
                            <span x-show="!showTableLong">GP</span>
                            <span x-show="showTableLong">Gegnerpunkte</span>
                        </th>
                        <th>
                            <span x-show="!showTableLong">PD</span>
                            <span x-show="showTableLong">Punktedifferenz</span>
                        </th>
                        <th>
                            <span x-show="!showTableLong">S</span>
                            <span x-show="showTableLong">Siege</span>
                        </th>
                        <th>
                            <span x-show="!showTableLong">U</span>
                            <span x-show="showTableLong">Unentschieden</span>
                        </th>
                        <th>
                            <span x-show="!showTableLong">N</span>
                            <span x-show="showTableLong">Niederlagen</span>
                        </th>
                        <th>
                            <span x-show="!showTableLong">Sp</span>
                            <span x-show="showTableLong">Spiele</span>
                        </th>
                        <th>
                            Runde
                        </th>
                        <template x-if="showTieBreakCols">
                            <th>
                                <span x-show="!showTableLong">LP</span>
                                <span x-show="showTableLong">Ligapunkte</span>
                            </th>
                        </template>
                        <template x-if="showTieBreakCols">
                            <th>
                                <span x-show="!showTableLong">MaxLP</span>
                                <span x-show="showTableLong">Max Ligapunkte</span>
                            </th>
                        </template>
                        <template x-if="showTieBreakCols">
                            <th>
                                <span x-show="!showTableLong">DS</span>
                                <span x-show="showTableLong">Direkte Siege</span>
                            </th>
                        </template>
                        <template x-if="showTieBreakCols">
                            <th>
                                <span x-show="!showTableLong">DPD</span>
                                <span x-show="showTableLong">Direkte Punktedifferenz</span>
                            </th>
                        </template>
                        <template x-if="showTieBreakCols">
                            <th>
                                <span x-show="!showTableLong">DEP</span>
                                <span x-show="showTableLong">Direkt Erzielte Punkte</span>
                            </th>
                        </template>
                        <template x-if="showTieBreakCols">
                            <th>
                                <span x-show="!showTableLong">SPD</span>
                                <span x-show="showTableLong">Summe Punktedifferenz</span>
                            </th>
                        </template>
                        <template x-if="showTieBreakCols">
                            <th>
                                <span x-show="!showTableLong">SEP</span>
                                <span x-show="showTableLong">Summe Erzielte Punkte</span>
                            </th>
                        </template>
                    </tr>
                    </thead>

                    <tbody>
                    {% for row in info.table %}
                    <tr class="{{ row.bg_class }}"
                        x-show="fuzzyMatch(search, `{{ row.team__name }}`)">
                        {% if user.is_staff %}
                        <td>{{ row.team_id }}</td>
                        {% endif %}

                        <td>{{ row.rank }}</td>
                        <td x-html="highlightMultiple(`{{ row.team__name }}`)"></td>
                        <td>{{ row.league_quotient }}</td>
                        <td>{{ row.pf }}</td>
                        <td>{{ row.pa }}</td>
                        <td>{{ row.diff }}</td>
                        <td>{{ row.wins }}</td>
                        <td>{{ row.draws }}</td>
                        <td>{{ row.losses }}</td>
                        <td>{{ row.games_played }}</td>
                        <td>{{ row.standing }}</td>
                        <template x-if="showTieBreakCols">
                            <td>{{ row.league_points }}</td>
                        </template>
                        <template x-if="showTieBreakCols">
                            <td>{{ row.max_league_points }}</td>
                        </template>
                        <template x-if="showTieBreakCols">
                            <td>{{ row.direct_wins|default_if_none:"" }}</td>
                        </template>
                        <template x-if="showTieBreakCols">
                            <td>{{ row.direct_point_diff|default_if_none:"" }}</td>
                        </template>
                        <template x-if="showTieBreakCols">
                            <td>{{ row.direct_points_scored|default_if_none:"" }}</td>
                        </template>
                        <template x-if="showTieBreakCols">
                            <td>{{ row.overall_point_diff|default_if_none:"" }}</td>
                        </template>
                        <template x-if="showTieBreakCols">
                            <td>{{ row.overall_points_scored|default_if_none:"" }}</td>
                        </template>
                        <td></td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock content %}
