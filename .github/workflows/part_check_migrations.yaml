name: ğŸ§ªğŸ³ Check Django migrations

on:
  workflow_call:
    inputs:
      artifact_name:
        required: true
        description: The name of the artifact containing the Docker image
        type: string
      image_name:
        required: false
        default: backend
        description: The name of the Docker image
        type: string
    secrets:
      MYSQL_HOST:
        required: true
        description: Remote MySQL host
      MYSQL_DB_NAME:
        required: true
        description: Remote MySQL database name
      MYSQL_USER:
        required: true
        description: Remote MySQL user
      MYSQL_PWD:
        required: true
        description: Remote MySQL password

permissions:
  contents: read

jobs:
  check-migrations:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: ğŸ“¥ Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: /tmp

      - name: ğŸ³ Load Docker image
        run: |
          docker load --input /tmp/${{ inputs.image_name }}.tar
          docker image ls -a

      - name: ğŸ§ª Run Django system check
        run: |
          echo "ğŸ” Running Django system check in image: ${{ inputs.image_name }}:latest"
          docker run --rm \
            -e MYSQL_HOST="${{ secrets.MYSQL_HOST }}" \
            -e MYSQL_DB_NAME="${{ secrets.MYSQL_DB_NAME }}" \
            -e MYSQL_USER="${{ secrets.MYSQL_USER }}" \
            -e MYSQL_PWD="${{ secrets.MYSQL_PWD }}" \
            ${{ inputs.image_name }}:latest \
            python manage.py check

      - name: ğŸ§± Check for missing migrations
        id: check_migrations
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for missing migrations in image: ${{ inputs.image_name }}:latest"
          docker run --rm \
            -e MYSQL_HOST="${{ secrets.MYSQL_HOST }}" \
            -e MYSQL_DB_NAME="${{ secrets.MYSQL_DB_NAME }}" \
            -e MYSQL_USER="${{ secrets.MYSQL_USER }}" \
            -e MYSQL_PWD="${{ secrets.MYSQL_PWD }}" \
            ${{ inputs.image_name }}:latest \
            python manage.py makemigrations --check --dry-run

      - name: ğŸ—ºï¸ Show migration plan
        run: |
          echo "ğŸ” Showing migration plan for image: ${{ inputs.image_name }}:latest"
          docker run --rm \
            -e MYSQL_HOST="${{ secrets.MYSQL_HOST }}" \
            -e MYSQL_DB_NAME="${{ secrets.MYSQL_DB_NAME }}" \
            -e MYSQL_USER="${{ secrets.MYSQL_USER }}" \
            -e MYSQL_PWD="${{ secrets.MYSQL_PWD }}" \
            ${{ inputs.image_name }}:latest \
            python manage.py migrate --plan

      - name: âœ… Validate migration check results
        if: steps.check_migrations.outcome == 'failure'
        run: |
          echo "::error::âŒ Missing migrations detected! Please run 'python manage.py makemigrations' and commit the generated migration files."
          exit 1
