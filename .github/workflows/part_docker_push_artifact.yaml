name: ğŸ³ğŸš€ Push Docker Image to Registry

on:
  workflow_call:
    inputs:
      artifact_name:
        required: true
        description: The name of the artifact containing the Docker image
        type: string
      image_name:
        required: true
        description: The name/path of the Docker image in the registry (e.g., leaguesphere/backend)
        type: string
      local_image_name:
        required: false
        default: backend
        description: The local name of the Docker image (used when loading from tar)
        type: string
      version:
        required: false
        default: latest
        description: The version tag to use when pushing
        type: string
    secrets:
      DOCKER_TOKEN:
        required: true
        description: Docker Hub token for authentication

permissions:
  contents: read

env:
  REGISTRY: docker.io

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: ğŸ“¥ Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: /tmp

      - name: ğŸ³ Load Docker image
        run: |
          docker load --input /tmp/${{ inputs.local_image_name }}.tar
          docker image ls -a

      - name: ğŸ³ğŸ› ï¸ Setup Docker buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”ğŸ“¦ Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: ğŸ³ğŸ·ï¸ Tag Docker image
        run: |
          docker tag ${{ inputs.local_image_name }}:latest ${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ inputs.version }}
          docker tag ${{ inputs.local_image_name }}:latest ${{ env.REGISTRY }}/${{ inputs.image_name }}:latest

      - name: ğŸ³ğŸš€ Push Docker image
        run: |
          docker push ${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ inputs.version }}
          docker push ${{ env.REGISTRY }}/${{ inputs.image_name }}:latest
